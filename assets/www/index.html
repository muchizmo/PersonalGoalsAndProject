<!DOCTYPE HTML>
<html>
<head>
<title>PhoneGap</title>
<script type="text/javascript" charset="utf-8" src="cordova-1.8.1.js"></script>
<script type="text/javascript" charset="utf-8" src="jquery-1.8.2.min.js"></script>
<script type="text/javascript" charset="utf-8" src="jquery.mobile-1.2.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="jquery.mobile-1.2.0.min.css" media="screen" />
<script type="text/javascript">
    /**
    $(document).ready( function () {

        $('#projectsListPage').live ('pagecreate', function(){
            $('#projectsList').delegate('li', 'vclick', function(){
                alert('list item clicked');
            });
        });
        $('#projectsList').listview('refresh');
    });
    */
</script>
<style type="text/css">
#startBtn,#pauseBtn {
	color: blue;
}

.hoursCounter {
	background-color: LightGreen;
	width: 400px;
	min-height: 40px;
	min-height: 100%;
}

.separator {
	background-color: LightBlue;
	width: 400px;
	height: 4px;
}

.startTime {
	color: gray;
}
</style>
<title>Reporter</title>
<style type='text/css'>
body {
	font-family: sans-serif;
}
</style>
</head>
<body>
	<script>
	
		projectsList=[];
		
		$(document).ready(
			function(){
				$.ajax( { url: "https://api.mongolab.com/api/1/databases/my_projects/collections/projects?s={'updated': 1}&apiKey=507d8f9be4b0335961b8c0f5",
			          type: "GET",
			          contentType: "application/json",
			          cache:false,
			          success: function(data){
			        	  for(i in data){
			        		  projectsList.push(data[i]);  
			        	  }
			        	  loadProjects();
			          }
				} );
			}		
		)

        function getOrderedProjectsList(){

        }
		
		function loadProjects(){
			for(var i = projectsList.length-1; i > 0; i--){
				createProjectListRecord(projectsList[i]);
			}
		}

        function reloadProjects(){
            clearProjectsPage();
            loadProjects();
        }

        function clearProjectsPage(){
            $("#projectsList").empty();
        }

        //onclick="addHourToProject('+project+')"
        //+project.name+
        //'<span id="totalHours_"'+project._id["$oid"]+' class="ui-li-count">'+projectTotalHours(project)+'</span>' +
        function createProjectListRecord(project){
            var project_id=project._id["$oid"];
            $("#projectsList").append(
                    '<li>' +
                            '<a id="addHour_'+project_id+'")>'+project.name+
                                '<span id="totalHours_'+project_id+'" class="ui-li-count">'+projectTotalHours(project)+'</span>' +
                            '</a>' +
                            '<a href="#hoursNotesPage" id="hoursNotes_'+project_id+'"></a>'+
                    '</li>');
            $('#addHour_'+project_id).bind('click',
                function(event){
                    addHourToProject(project_id);
                }
            )

            $('#hoursNotes_'+project_id).bind('click',
                    function(event){

                    }
            )

            $("#projectsList").listview('refresh');
        }

        //TODO API dependent
        function notesPagePrepare(project_id){
            var project=findProjectById(project_id);
        }

        function findProjectById(id){
			for(project in projectsList){
				if(projectsList[project]._id["$oid"]==id){
					return projectsList[project];
				}
			}
		}
		
		function updateProject(project){
			project.updated=new Date().getTime();
			$.ajax( { url: "https://api.mongolab.com/api/1/databases/my_projects/collections/projects?apiKey=507d8f9be4b0335961b8c0f5",
		          	data:JSON.stringify(project),
		          	cache:false,
					type: "POST",
		          	contentType: "application/json",
                    success:function(){
                        reloadProjects();
                    }
			});	
		}
		
		
		//TODO API dependent
		function projectTotalHours(project){
			totalHours=0;
			for(entry in project.hours){
				totalHours+=project.hours[entry].spent;
			}
			return totalHours;
		}
		
		//TODO API related fields.
		function addHourToProject(project_id){
            var project=findProjectById(project_id)
			var spentHoursEntry={};
			spentHoursEntry.spent=1;
			spentHoursEntry.when=new Date().getTime();
			project.hours.push(spentHoursEntry);
			updateProject(project);
		}
		
		//create empty project after user click
		function addNewProject(){
			var newProject={};
			newProject.created=new Date().getTime();
			newProject.updated=newProject.created;
			newProject.name="";
			newProject.hours=[];
			$.ajax( { url: "https://api.mongolab.com/api/1/databases/my_projects/collections/projects?apiKey=507d8f9be4b0335961b8c0f5",
		          data:JSON.stringify(newProject),
					type: "POST",
		          contentType: "application/json",
		          cache:false,
		          success: function(data){
		        	  newProject._id={}
		        	  newProject._id["$oid"]=data._id["$oid"];
		        	  projectsList.push(newProject);
		        	  addProject(newProject);
		          }
			});
		}
	
		//used to populate gui
		function addProject(project) {
			
			$('.hoursCounterTemplate')
								.clone()
								.removeClass('hoursCounterTemplate')
								.addClass('hoursCounter')
								.attr("id",project._id["$oid"])
								.appendTo('#interactBlock');
			if(project.name==""){
				$('#'+project._id["$oid"]+' .descriptionSubmit').html(project.name)
				.css('display', 'inline');	
			}

		}
		
		function descriptionEdit(event) {
			$(event.target).css('display', 'none')
			$(event.target).parent().find('.descriptionSubmit').css('display',
					'inline')
		}
		function textAreaSubmit(event) {
			//TODO update
			if (13 == event.keyCode) {
				var projectId=$(event.target).parent().attr('id');
				var project=findProjectById(projectId);
				project.name=$(event.target).val();
				//ajax update 
				updateProject(project);
				$(event.target).css('display', 'none');
			}
		}
		function onTextAreaBlur(event) {
			//TODO update
			$(event.target).css('display', 'none')
		}
	</script>
    <div data-role="page" id="projectsListPage">
        <div data-role="header">
            <h1>Projects List</h1>
        </div><!-- /header -->
        <div data-role="content">
            <div id="interactBlock">
                <div id="btns">
                    <a id='addProjectBtn' onclick='return addNewProject()'>Add Project</a>
                </div>
                <div class='hoursCounterTemplate'>
                    <a class="description" onclick='return descriptionEdit(event)'></a>
                    <textarea class='descriptionSubmit' rows="1" cols="20"
                              style='display: none' onblur='onTextAreaBlur(event)'
                              onkeypress='return textAreaSubmit(event)'></textarea>
                    <br>
                </div>
            </div>
            <ul data-role="listview" id="projectsList" data-filter="true">
            </ul>
        </div><!-- /content -->
    </div><!-- /page -->

    <div data-role="page" id="hoursNotesPage">
        <div data-role="header">
            <h1>Hours Notes</h1>
        </div><!-- /header -->
        <div data-role="content">
            <ul data-role="listview" id="hoursNotes" data-filter="true">

            </ul>
        </div><!-- /content -->
    </div><!-- /page -->
</body>
</html>